{% extends "base.html" %}
{% block body %}
<h1 id="app_page" class="mt-3 mb-3">
  <a href="{{ url('index') }}">Wharf</a>
  <span class="text-muted">/</span>
  {{ app }}
</h1>

<h2 class="mb-3">Actions</h2>
{% if git_url == None %}
<div class="alert alert-warning">
  Can't deploy due to missing GITHUB_URL in config (which should be set to the "Clone with HTTPS" url from Github)
</div>
{% else %}
<form class="form-inline" action="{{ url('deploy', app_name=app) }}" method="POST">
  {% csrf_token %}
  <input type="hidden" name="url" value="{{ git_url }}" />
  <button type="submit" class="btn btn-primary">Deploy app</button>
</form>
{% endif %}

<h2 class="mb-3">Task logs</h2>
{% if task_logs %}
<div class="list-group">
  {% for tl in task_logs %}
    <a class="list-group-item list-group-item-action" href="{{ url('show_log', task_id=tl.task_id) }}">
      {{ tl.nice_when() }} - {{ tl.description }}
    </a>
  {% endfor %}
</div>
{% else %}
No tasks run yet
{% endif %}

<h2 class="mb-3">
  Domains
  <button
    class="btn btn-primary float-right"
    type="button"
    data-toggle="collapse"
    data-target="#new-domain"
    aria-expanded="false"
    aria-controls="new-domain"
  >
    <i class="octicon-plus"></i> New domain
  </button>
</h2>
<div class="collapse" id="new-domain">
  <div class="card">
    <div class="card-body">
      <h3 class="card-title">New domain</h3>
      <form action="{{ url('add_domain', app_name=app) }}" method="POST">
        {% csrf_token %}
        {{ domain_form | bootstrap }}
        <input class="form-control" type="submit" value="Submit" />
      </form>
    </div>
  </div>
</div>

{% if domains.length == 0 %}None{% else %}
<ul class="list-group">
  {% for d in domains %}
    <li class="list-group-item">
      <div class="d-flex justify-content-between align-items-center">
        <a href="{{ 'https' if letsencrypt else 'http' }}://{{ d }}">{{ d }}</a>
        <form action="{{ url('remove_domain', app_name=app) }}" method="POST">
        {% csrf_token %}
          <input type="hidden" name="name" value="{{d}}" />
          <button type="submit" class="btn btn-primary">Delete '{{d}}' domain</button>
        </form>
      </div>
    </li>
  {% endfor %}
</ul>
{% endif %}

<h2 class="mb-3">
  Config
  <button
    class="btn btn-primary float-right"
    type="button"
    data-toggle="collapse"
    data-target="#new-config"
    aria-expanded="false"
    aria-controls="new-config"
  >
    <i class="octicon-plus"></i> New item
  </button>
</h2>
<div class="collapse" id="new-config">
  <div class="card">
    <div class="card-body">
      <h3 class="card-title">New item</h3>
      <form action="{{ url('app_info', app_name=app) }}" method="POST">
        {% csrf_token %}
        {{ form | bootstrap }}
        <input class="form-control" type="submit" value="Submit" />
      </form>
    </div>
  </div>
</div>

<table class="config table table-bordered rounded bg-white mb-4">
  <thead class="sr-only">
    <th>Key</th>
    <th>Value</th>
  </thead>
  <tbody>
    {% for (k,v) in config %}
      <tr>
        <td>{{ k }}</td>
        <td>{{ v }}</td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<h2 class="mb-3">Plugins</h2>

<div class="card mb-3">
  <div class="card-body">
    <h3 class="card-title">Postgres</h3>
    {% if postgres %}
    Status: {{ postgres['STATUS'] }}
    {% else %}
    <form class="form-inline" action="{{ url('create_postgres', app_name=app) }}" method="POST">
      {% csrf_token %}
      <button type="submit" class="btn btn-primary"><i class="octicon-plug"></i> Create postgres db</button>
    </form>
    {% endif %}
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <h3 class="card-title">Redis</h3>
    {% if redis %}
    Status: {{ redis['STATUS'] }}
    {% else %}
    <form class="form-inline" action="{{ url('create_redis', app_name=app) }}" method="POST">
      {% csrf_token %}
      <button type="submit" class="btn btn-primary"><i class="octicon-plug"></i> Create redis db</button>
    </form>
    {% endif %}
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <h3 class="card-title">Let's Encrypt</h3>
    {% if letsencrypt %}
    <ul>
      {% for (k,v) in letsencrypt.items() if k != 'App name' %}
      <li>{{k}}: {{v}}</li>
      {% endfor %}
    </ul>
    {% else %}
    <form class="form-inline" action="{{ url('setup_letsencrypt', app_name=app) }}" method="POST">
      {% csrf_token %}
      <button type="submit" class="btn btn-primary"><i class="octicon-plug"></i> Setup Let's Encrypt</button>
    </form>
    {% endif %}
  </div>
</div>

<h2 class="mb-3">Process Info</h2>
<div class="card mb-4">
  <div class="card-body">
    <ul class="list-unstyled mb-0">
      {% for (k,v) in process.items() if k!= 'processes' %}
      <li>{{k}}: {{v}}</li>
      {% endfor %}
    </ul>
  </div>
</div>

<h2 class="mb-3">Processes</h2>
<ul class="list-group mb-4">
  {% for (k,v) in process['processes'].items() %}
  <li class="list-group-item d-flex justify-content-between align-items-center">
    {{k}}
    <span class="badge {% if v == 'running' %}badge-success{% else %}badge-secondary{% endif %}">
      {{v}}
    </span>
  </li>
  {% endfor %}
</ul>

<h2 class="mb-3">Logs</h2>
<pre class="card mb-4">
  <code class="card-body">{{ logs }}</code>
</pre>
{% endblock %}