{% extends "base.html" %}
{% block body %}
<h1 id="app_page" ><a href="{{ url('index') }}">Wharf</a> / {{ app }}</h1>

<h3>Actions</h3>
{% if git_url == None %}
<div class="alert alert-warning">
  Can't deploy due to missing GITHUB_URL in config (which should be set to the "Clone with HTTPS" url from Github)
</div>
{% else %}
<form class="form-inline" action="{{ url('deploy', app_name=app) }}" method="POST">
  {% csrf_token %}
  <input type="hidden" name="url" value="{{ git_url }}" />
  <button type="submit" class="btn btn-primary">Deploy app</button>
</form>
{% endif %}

<h2>Task logs</h2>
{% if task_logs %}
<div class="list-group">
  {% for tl in task_logs %}
    <a class="list-group-item" href="{{ url('show_log', task_id=tl.task_id) }}">{{ tl.nice_when() }} - {{ tl.description }}</a></li>
  {% endfor %}
</div>
{% else %}
No tasks run yet
{% endif %}

<h2>
  Domains
  <button
    class="btn btn-primary float-right"
    type="button"
    data-toggle="collapse"
    data-target="#new-domain"
    aria-expanded="false"
    aria-controls="new-domain"
  >
    <i class="remixicon-add-line"></i> Add domain
  </button>
</h2>
<div class="card collapse" id="new-domain">
  <div class="card-body">
    <h3 class="card-title">New domain</h3>
    <form action="{{ url('add_domain', app_name=app) }}" method="POST">
      {% csrf_token %}
      {{ domain_form | bootstrap }}
      <input class="form-control" type="submit" value="Submit" />
    </form>
  </div>
</div>

{% if domains.length == 0 %}None{% else %}
<ul class="list-group">
  {% for d in domains %}
    <li class="list-group-item">
      <div class="d-flex justify-content-between align-items-center">
        <a href="{{ 'https' if letsencrypt else 'http' }}://{{ d }}">{{ d }}</a>
        <form action="{{ url('remove_domain', app_name=app) }}" method="POST">
        {% csrf_token %}
          <input type="hidden" name="name" value="{{d}}" />
          <button type="submit" class="btn btn-primary">Delete '{{d}}' domain</button>
        </form>
      </div>
    </li>
  {% endfor %}
</ul>
{% endif %}

<h2>
  Config
  <button
    class="btn btn-primary float-right"
    type="button"
    data-toggle="collapse"
    data-target="#new-config"
    aria-expanded="false"
    aria-controls="new-config"
  >
    <i class="remixicon-add-line"></i> Add item
  </button>
</h2>
<div class="card collapse" id="new-config">
  <div class="card-body">
    <h3 class="card-title">New item</h3>
    <form action="{{ url('app_info', app_name=app) }}" method="POST">
      {% csrf_token %}
      {{ form | bootstrap }}
      <input class="form-control" type="submit" value="Submit" />
    </form>
  </div>
</div>

<table class="config table">
  <thead class="sr-only">
    <th>Key</th>
    <th>Value</th>
  </thead>
  <tbody>
    {% for (k,v) in config %}
      <tr>
        <td>{{ k }}</td>
        <td>{{ v }}</td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<h2>Plugins</h2>
<h3>Postgres</h3>
{% if postgres %}
Status: {{ postgres['STATUS'] }}
{% else %}
<form class="form-inline" action="{{ url('create_postgres', app_name=app) }}" method="POST">
  {% csrf_token %}
  <button type="submit" class="btn btn-primary">Create postgres db</button>
</form>
{% endif %}
<h3>Redis</h3>
{% if redis %}
Status: {{ redis['STATUS'] }}
{% else %}
<form class="form-inline" action="{{ url('create_redis', app_name=app) }}" method="POST">
  {% csrf_token %}
  <button type="submit" class="btn btn-primary">Create redis db</button>
</form>
{% endif %}
<h3>Let's Encrypt</h3>
{% if letsencrypt %}
<ul>
  {% for (k,v) in letsencrypt.items() if k != 'App name' %}
  <li>{{k}}: {{v}}</li>
  {% endfor %}
</ul>
{% else %}
<form class="form-inline" action="{{ url('setup_letsencrypt', app_name=app) }}" method="POST">
  {% csrf_token %}
  <button type="submit" class="btn btn-primary">Setup Let's Encrypt</button>
</form>
{% endif %}

<h2>Process Info</h2>
<div class="card">
  <div class="card-body">
    <ul>
      {% for (k,v) in process.items() if k!= 'processes' %}
      <li>{{k}}: {{v}}</li>
      {% endfor %}
    </ul>
  </div>
</div>

<h2>Processes</h2>
<ul class="list-group">
  {% for (k,v) in process['processes'].items() %}
  <li class="list-group-item d-flex justify-content-between align-items-center">
    {{k}}
    <span class="badge {% if v == 'running' %}badge-success{% else %}badge-secondary{% endif %}">
      {{v}}
    </span>
  </li>
  {% endfor %}
</ul>

<h2>Logs</h2>
<pre class="card">
  <code class="card-body">
    {{ logs }}
  </code>
</pre>
{% endblock %}